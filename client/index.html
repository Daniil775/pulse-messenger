<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="module" src="./js/index.js" defer></script>
    <link rel="stylesheet" href="./style/style.css">
    <link rel="manifest" href="./manifest.json">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div id="root">
        <div id="app">

            <header>
                <div id="logo"><img src="./assets/pulse-logo-192.jpg" alt=""></div>
                <nav>
                    <ul>
                        <li><a href="">Chats</a></li>
                        <li><a href="">Settings</a></li>
                        <li><a href="">Support</a></li>
                    </ul>
            </nav>
            <div id="account">
                <img src="./assets/avatars/logo.png" alt="">
                <div>
                <div id="name"></div>
                <div id="email">Your_Mail@mail.com</div>
                </div>
            </div>
            </header>
            
            <main>
                <aside id="left-side">
                    <ul class="contacts">
                        <li class="contact">
                            <div class="ava"><img src="./assets/avatars/logo2.png" alt=""></div>
                            <div class="contact-info">
                                <h4>Eyecode &copy; Community</h4>
                                <p> Message</p>
                                <div class="online-users-info">
                                    <img src="./assets/user-round.svg" alt="">
                                     <div id="online"></div> Online
                                    <div class="lighthouse"></div>
                                    
                                </div>
                                <ul class="username-list">

                                </ul>
                                
                            </div>
                        </li>
                    </ul>

                </aside>
                <section id="main-side">
                    <div id="fetch-voice">
                        <img src="./assets/mic.svg" alt="">
                    </div>
                    <div id="chat">
                        <div class="message">
                            <div class="message-box">
                                <div class="message-user">Rat</div>
                                <div class="message-text">Good morning, Hamster</div>
                            </div>
                            <div class="message-date">17:47</div>
                        </div>

                        
                    </div>
                    
                    <div id="main-side-controls">
                        <div id="typingIndicator"></div>
                        <div id="input-box"><input id="message" type="text" placeholder="text your message..."><button id="send-message">Send</button> <button id="send-mic"><img src="./assets/mic.svg" alt=""></button></div></div>
                    </div>
                </section>
            </main>

            <footer></footer>
        </div>
    </div>

    <script>
        const msgInp = document.querySelector("#message");
        const chat = document.querySelector("#chat");
        const sendBtn = document.querySelector("#send-message");
        let your_name = document.querySelector("#name");
        let contacts = document.querySelector(".contacts");
        let email = document.querySelector("#email");
        const onlineUsers = document.querySelector("#online");
        const typingInd = document.querySelector("#typingIndicator")

        const socket = io();
        const usernameInfo = prompt("Enter your name");
        const userEmailInfo = prompt("Enter your email");
        your_name.innerHTML = usernameInfo;
        email.innerHTML = userEmailInfo;
        let isTyping = false;
        let typingTimeout;
        let mediaRecorder;
        let mediaChunks = [];
        let sendMic = document.querySelector("#send-mic")
        let fetchVoice = document.querySelector("#fetch-voice")





        function sendMessage(){
            if(!msgInp.value){
                console.log("Message is empty");
                return;
            }
            let msg = msgInp.value;
            let now = new Date();
            let min = now.getMinutes();
            let hour = now.getHours();
           
                msgInp.value = "";
                socket.emit("chat message", {msg, hour, min, username: usernameInfo})
        }

        function sendVoiceMessage(audioUrl){
            let audio = new Audio(audioUrl);
            let container = document.createElement("div");
            container.classList.add("voice_message")
            let audio_msg_temp = `
            <div class="voice_message">
                      
                            <button class="play-btn">
                                <img src="./assets/play.svg" alt="">
                            </button>
                            <div class="progress-container">
                                <div class="progress"></div>
                            </div>
                            <span class="time">0:00</span>
                            
                            <button class="speed-btn">1x</button>
                    
                        </div>
            `
            container.innerHTML = audio_msg_temp;

            const playBtn = container.querySelector(".play-btn")
            const progress = container.querySelector(".progress")
            const progressContainer = container.querySelector(".progress-container")
            const timeDisplay = container.querySelector(".time")
            const speedBtn = container.querySelector(".speed-btn")
            const playBtnIcon = playBtn.querySelector("img")
  
            let speed = 1;

            playBtn.onclick = () => {
                if(audio.paused){
                    audio.play()
                    playBtnIcon.src = "../assets/pause.svg";
                }else{
                    audio.pause();
                    playBtnIcon.src = "../assets/play.svg";
                }
            }

            //updating progress
            audio.ontimeupdate = () =>{
                let precent = (audio.currentTime / audio.duration) * 100;
                progress.style.width = precent + '%' 

                const mins = Math.floor(audio.currentTime / 60);
                const secs = Math.floor(audio.currentTime % 60).toString().padStart(2,"0")
                timeDisplay.textContent = `${mins}:${secs}`;
            }

            //peremotka

            progressContainer.onclick = (e) =>{
                const width = progressContainer.clientWidth;
                const clickX = e.offsetX;
                audio.currentTime = (clickX /width) * audio.duration;
            }

            //speed

            speedBtn.onclick = () => {
                speed = speed === 1 ? 1.5 : speed === 1.5 ? 2 : 1;
                audio.playbackRate = speed;
                speedBtn.textContent = speed + "x"
            }

            return container;

        }
        
        
        socket.on("chat message", ({msg,hour,min,username}) =>{





            let isOwner = username === usernameInfo;
            
             let msg_template = `
            <div class="message ${isOwner ? "active" : ""}" >
                <div class="message-box ${isOwner ? "active-box" : ""}">
                    <div class="message-user">${username}</div>
                    <div class="message-text">${msg}</div>
                </div>
                <div class="message-date">${hour}:${min}</div>
            </div>
                `
            chat.innerHTML += msg_template
        })
        

        socket.on("user typing",(name)=>{
            typingInd.textContent = `${name} печатает...`
        })
        socket.on("user stop typing",(name)=>{
            typingInd.textContent = ``
        })

        sendMic.onclick = async() => {
            try{
                const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                fetchVoice.classList.add("active-mic");
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = (e) => {
                    mediaChunks.push(e.data);
                }

                mediaRecorder.onstop = async() => {
                    const audioBlob = new Blob(mediaChunks,{type:"audop/webm"});
                    const arrayBuffer = await audioBlob.arrayBuffer();
                    mediaChunks = [];
                    socket.emit("voice message",arrayBuffer);
                    console.log(audioBlob);
                    console.log(arrayBuffer);
                }

                mediaRecorder.start();
            }catch(err){
                console.log(err)
            }



        }
        msgInp.addEventListener("input", ()=>{
            if(!isTyping){
                isTyping = true;
                socket.emit("typing",usernameInfo)

            }

            clearTimeout(typingTimeout);

            typingTimeout = setTimeout(()=>{
                isTyping = false;
                socket.emit("stop typing",usernameInfo)
            },1500)
        })
        
        fetchVoice.addEventListener("click", ()=>{
            if(mediaRecorder){
                fetchVoice.classList.remove("active-mic");
                mediaRecorder.stop();
            }
        })

        socket.on("voice message", (data) =>{
            const blob = new Blob([data],{type:"audio/webm"});
            const audioUrl = URL.createObjectURL(blob);
            const audio = sendVoiceMessage(audioUrl);
            chat.appendChild(audio);
        })
        
        socket.on("online users", (data)=>{
            console.log(data)
            onlineUsers.innerHTML = data.count
        })


        socket.emit('set username',usernameInfo);

        socket.emit("join",usernameInfo);
        

        sendBtn.onclick = () => {
            sendMessage();
        }

        
    </script>
</body>
</html>